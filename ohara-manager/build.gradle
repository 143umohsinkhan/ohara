defaultTasks 'clean', 'build'

/**
 * clean all processes and files, and then install all dependencies
 */
task clean {
  if(!project.hasProperty('skipManager')) {
    doLast {
      // Need to install node packages before running "cleanup" process
      exec {
        commandLine 'yarn'
      }
      exec {
        commandLine 'yarn', 'clean:process'
      }
      exec {
        commandLine 'yarn', 'clean'
      }
    }
  }
}

task test {
  if(!project.hasProperty('skipManager')) {
    doLast {
      exec {
        commandLine 'yarn'
      }
      exec {
        commandLine 'yarn', 'test:ci'
      }
      exec {
        commandLine 'yarn', 'clean:process'
      }
    }
  }
}

task build {
  if(!project.hasProperty('skipManager')) {
    doLast {
      exec {
        commandLine 'yarn', 'checkYarnVersion'
      }
    }
    dependsOn test
  }
}

task runManager {
  description 'run a manager'
  doLast {
    // Need to install node packages before running the "cleanup" process
    exec {
      commandLine 'yarn'
    }
    exec {
      commandLine 'yarn', 'clean:process'
    }
    exec {
      commandLine 'yarn', 'clean'
    }
    exec {
      commandLine 'yarn', 'setup'
    }
    exec {
      // TODO: Chia please help refactor the following commands if needed, thanks! -- Joshua OCT. 22
      String configuratorPort = 9999
      if(project.hasProperty('configuratorPort')) configuratorPort = "${project.getProperty('configuratorPort')}"
      String configuratorHost = "localhost"
      if(project.hasProperty('configuratorHost')) configuratorHost = "${project.getProperty('configuratorHost')}"
      environment "CONFIGURATOR_API", "http://" + configuratorHost + ":" + configuratorPort + "/v0"

      // Run the gradle command like this: gradle runManager -PconfiguratorHost=http://10.1.0.161:7777/v0
      commandLine 'yarn', 'start:prod', '--configurator', configuratorHost
    }
  }
}
